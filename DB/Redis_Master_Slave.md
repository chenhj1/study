# Redis Master-Slave
redis模式主要有两种：
1. 主从模式。
2. 集群模式。

本文将介绍主从模式。

## 1. 主从模式概念
主从模式（`Mater-Slave`），由一台主（Master）服务器和多台从（Slave服务器组成），主库一般只进行写操作，从库一般只进行读操作。
数据写入主库后，自动同步给从库。实现读写分离，提高负载能力。

> 注：主库也可以读，从库通过配置也可以写，只不过一般不这么做。

## 2. Redis主从模式实现原理：

### 1.建立连接阶段
建立连接过程的作用是在主节点和从节点之间建立连接，以便后续的数据传输，过程比较偏底层，大致过程是：
1. 从节点在配置文件中，保存了主节点的IP和Port信息。
2. **从节点向主节点建立socket连接，建立一个“事件处理器”，负责后续的复制工作，如RDB文件传输、命令传输等。**
3. **主节点的socket执行accept之后，为改从节点创建相应的客户端状态，并将从节点看做一个“客户端”。**
4. 从节点发送ping命令，作用是检查socket连接是否可用。
5. 如果开启了身份验证，则进行身份验证。
6. 从节点发送监听的主节点的端口号，在主节点保存。该步骤除了显示info使用外，没有太大作用。

### 2.数据同步阶段
数据同步阶段是从库向主库发送`psync`命令开始的（redis2.8以前是`sync`），根据数据状态的不同，又分为**全量复制**和**部分复制**。

> 注：在建立连接阶段，从节点是主节点的客户端。而到了数据同步阶段，主从二者互为客户端，原因是：建立连接阶段，主节点只需要接收从节点的命令即可，
而到了数据同步阶段，从节点需要接受主节点的数据，如写入缓冲区的命令等。

**全量复制**   

将主节点的所有数据同步给从节点，用于初次启动、或无法进行部分复制的场景，是个非常重的操作。

1. 从库启动，发送一个“全量复制”命令给主库。
2. 主库收到命令，fork子进程执行bgsave，保存快照RDB文件，期间缓存所有收到的命令。
3. 快照完成后，主库发送RDB文件到从库。
4. 从库收到后，**首先清空自己的数据**，然后载入RDB文件。
5. 主节点发送缓存的命令给从节点，从节点执行。然后状态恢复成和主节点保持一致。

**部分复制**

部分复制依赖于3个概念：
1. 复制偏移量   
复制偏移量是一个offset，主从节点各自都有保存。主节点同步1个字节给从节点，主节点offset+1。同理，从节点接收到主节点的数据，从节点offset+1。
通过比较主从二者的offset，可以知道还有多少字节未完成复制。
2. 复制挤压缓冲区
复制及压缓冲区是一个FIFO队列，由主节点维护，固定大小默认1M。它按顺序存储着主节点最近执行的命令。   
主节点根据offset和缓冲区大小，决定能否进行部分复制。如果offset之后的数据已不在缓冲区（数据被队列挤出），则只能进行全量复制。
3. 服务器运行ID
无论主从，每个Redis节点在启动时都会生成一个随机唯一ID。其中主节点的ID会发送给从节点保存。   
有断线重连时：
    * 如果从节点保存的主节点ID与现在的主节点ID相同，则说明以前同步过，主节点尝试使用部分复制。（最终还要看offset和缓冲区队列决定能不能部分复制）
    * 如果从节点保存的主节点ID与现在的主节点ID不同，则说明断线前从节点复制的主节点不是当前的主节点，只能抹掉数据，全量复制。

### 3.命令传播阶段
数据同步阶段完成后，主节点开始将自己执行的命令不断地发送给从节点执行，保证数据一致性。   
由于主库同步命令到从库、从库执行命令需要时间，因此会带来一定的“主从延迟”问题。


## 3. Redis主从模式在应用中的问题：
#### 1. 经典的“主从延迟”问题
redis写入后立即读取。因为数据写入主库后，还没来得及同步给从库，客户端就读取了从库，所以读不到数据。
#### 2. 数据过期问题 
对于单机版的Redis，有两种删除数据策略：
    * 惰性删除。redis不会主动删除过期数据，只有当这个数据被查询到时，判断是否过期，决定是否返回和是否删除。
    * 定期删除。redis执行定时任务，删除过期数据，但是这个操作比较吃资源，所以不频繁。
    
    对于redis主从模式，为了保证主从数据一致性，从节点不会主动删除数据，而是由主节点控制删除并同步命令给从节点。   
    在redis老版本中，由于主节点的惰性删除和定期删除都不能即使保证过期数据被删除，所以从节点很容易读到过期数据。
    > 注：redis3.2版本后，读取从节点数据增加了对过期时间的判断，如果过期，不返回给客户端。

#### 3. 故障切换问题
主从模式只是提高了redis的负载能力，但是对于容灾能力没有明显提升，主库宕机后，需要手动迅速修改配置文件，修改从库为主库。
